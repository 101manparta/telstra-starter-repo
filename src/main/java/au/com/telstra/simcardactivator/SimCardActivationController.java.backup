package au.com.telstra.simcardactivator;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import au.com.telstra.simcardactivator.entity.SimCard;
import au.com.telstra.simcardactivator.repository.SimCardRepository;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

import java.util.Optional;

@RestController
@RequestMapping("/api")
public class SimCardActivationController {

    @Autowired
    private SimCardRepository simCardRepository;

    private final RestTemplate restTemplate = new RestTemplate();
    private final String activatorUrl = "http://localhost:8081/activate";

    @PostMapping("/activate")
    public ResponseEntity<String> activateSimCard(@RequestBody SimCard request) {
        try {
            // Send activation request to external service
            ResponseEntity<ActivationResult> response = restTemplate.postForEntity(
                activatorUrl,
                request,
                ActivationResult.class
            );

            boolean success = response.getBody() != null && response.getBody().isSuccess();
            
            // Save to database
            SimCard simCard = new SimCard(
                request.getIccid(),
                request.getCustomerEmail(),
                success
            );
            simCardRepository.save(simCard);

            if (success) {
                return ResponseEntity.ok("SIM card activated successfully!");
            } else {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                    .body("SIM card activation failed!");
            }
        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body("Error: " + e.getMessage());
        }
    }

    @GetMapping("/query")
    public ResponseEntity<?> querySimCard(@RequestParam Long simCardId) {
        Optional<SimCard> simCardOptional = simCardRepository.findById(simCardId);
        
        if (simCardOptional.isPresent()) {
            SimCard simCard = simCardOptional.get();
            return ResponseEntity.ok(simCard);
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body("SIM card not found with ID: " + simCardId);
        }
    }

    @GetMapping("/queryByIccid")
    public ResponseEntity<?> querySimCardByIccid(@RequestParam String iccid) {
        Optional<SimCard> simCardOptional = simCardRepository.findByIccid(iccid);
        
        if (simCardOptional.isPresent()) {
            SimCard simCard = simCardOptional.get();
            return ResponseEntity.ok(simCard);
        } else {
            return ResponseEntity.status(HttpStatus.NOT_FOUND)
                .body("SIM card not found with ICCID: " + iccid);
        }
    }

    @JsonIgnoreProperties(ignoreUnknown = true)
    static class ActivationResult {
        private boolean success;

        public boolean isSuccess() {
            return success;
        }

        public void setSuccess(boolean success) {
            this.success = success;
        }
    }
}